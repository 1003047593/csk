# 应用性能监控 {#task_1198516 .task}

应用性能监控是深入应用内部的一种诊断和监控的方式，开发者可以通过应用性能监控，可以深入观测语言、框架、虚拟机层面的各种指标，为性能调优、问题诊断提供了更多的选择。

-   您已成功创建一个 Kubernetes 集群。参见[创建Kubernetes集群](intl.zh-CN/用户指南/Kubernetes集群/集群管理/创建Kubernetes集群.md#)。
-   您已经成功开通 ARMS应用监控服务。参见[开通 ARMS 应用监控服务](https://www.alibabacloud.com/help/zh/doc-detail/66684.html)。

阿里云推出了应用监控服务（Application Performance Management Service），是一款针对 Java 应用的性能管理（Application Performance Management，简称 APM）软件。无需修改任何代码，只需通过Helm Chart安装即可自动服务发现安装探针，该探针就能够对您的 Java 应用进行全方位监控，帮助您更快速地定位出错接口和慢接口、重现调用参数、检测内存泄漏、发现系统瓶颈，从而大幅提升线上问题诊断问题的效率。ARMS产品详细介绍请参考[产品概述](../../../../intl.zh-CN/产品简介/产品概述.md#)。

1.  组件部署。 
    1.  登录[容器服务管理控制台](https://cs.console.aliyun.com/?spm=a2c4g.11186623.2.7.1PrXU7#/overview/all)。
    2.  在 Kubernetes 菜单下，在左侧导航栏选择**市场** \> **应用目录**，在右侧选中**ack-arms-pilot**。 

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/961258/156351910951620_zh-CN.png)

    3.  在应用目录 - ack-arms-pilot中，在右侧的创建页面选择目标集群和命名空间后，单击**创建**，添加ARMS应用监控组件。
2.  授予容器服务ARMS调用权限。 
    1.  使用主账号登录[容器服务管理控制台](https://cs.console.aliyun.com/?spm=a2c4g.11186623.2.7.1PrXU7#/overview/all)。
    2.  在 Kubernetes 菜单下，在左侧导航栏选择**集群** \> **集群**，在目标集群右侧操作列单击**管理**，进入集群详情页面。 

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/961258/156351910951632_zh-CN.png)

    3.  单击Worker RAM角色，进入RAM控制台。 

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/961258/156351911051621_zh-CN.png)

    4.  单击目标权限策略名称，进入角色权限详情页面。 

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/961258/156351911051626_zh-CN.png)

    5.  单击**修改策略内容**，从右侧滑出修改策略内容页面，将如下内容填入**策略内容**中，单击**确认**，完成授权配置。 

        ``` {#codeblock_b8c_itc_vf7}
                     {
                        "Action": "arms:*",
                        "Resource": "*",
                        "Effect": "Allow"
                     }
        ```

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/961258/156351911051630_zh-CN.png)

3.  开启 ARMS 应用监控。 您可以在 Yaml 中添加 annotations 的方式开启 ARMS，其中armsPilotCreateAppName的值会自动成为 ARMS 中应用的名称。

    1.  创建arms-demo命名空间。请参见[创建命名空间](intl.zh-CN/用户指南/Kubernetes集群/命名空间管理/创建命名空间.md#)。
    2.  打开您的Deployment 的 Yaml 文件arms\_demo.yaml，在spec-\>template-\>metadata下的 annotations 字段中加入如下内容。

        ``` {#codeblock_hqh_tus_ov0}
            annotations:
                armsPilotAutoEnable: "on"
                armsPilotCreateAppName: "arms-k8s-demo"
        ```

        Yaml 文件完整样例如下：

        ``` {#codeblock_s3f_dat_n0y}
        apiVersion: v1
        kind: Namespace
        metadata:
          name: arms-demo
        ---
        apiVersion: apps/v1beta1 # for versions before 1.8.0 use apps/v1beta1
        kind: Deployment
        metadata:
          name: arms-springboot-demo
          namespace: arms-demo
          labels:
            app: arms-springboot-demo
        spec:
          replicas: 2
          selector:
            matchLabels:
              app: arms-springboot-demo
          template:
            metadata:
              annotations:
                armsPilotAutoEnable: "on"
                armsPilotCreateAppName: "arms-k8s-demo"
              labels:
                app: arms-springboot-demo
            spec:
              containers:
                - resources:
                    limits:
                      cpu: 0.5
                  image: registry.cn-hangzhou.aliyuncs.com/arms-docker-repo/arms-springboot-demo:v0.1
                  imagePullPolicy: Always
                  name: arms-springboot-demo
                  env:
                    - name: SELF_INVOKE_SWITCH
                      value: "true"
                    - name: COMPONENT_HOST
                      value: "arms-demo-component"
                    - name: COMPONENT_PORT
                      value: "6666"
                    - name: MYSQL_SERVICE_HOST
                      value: "arms-demo-mysql"
                    - name: MYSQL_SERVICE_PORT
                      value: "3306"
        ---
        apiVersion: apps/v1beta1 # for versions before 1.8.0 use apps/v1beta1
        kind: Deployment
        metadata:
          name: arms-springboot-demo-subcomponent
          namespace: arms-demo
          labels:
            app: arms-springboot-demo-subcomponent
        spec:
          replicas: 2
          selector:
            matchLabels:
              app: arms-springboot-demo-subcomponent
          template:
            metadata:
              annotations:
                armsPilotAutoEnable: "on"
                armsPilotCreateAppName: "arms-k8s-demo-subcomponent"
              labels:
                app: arms-springboot-demo-subcomponent
            spec:
              containers:
                - resources:
                    limits:
                      cpu: 0.5
                  image: registry.cn-hangzhou.aliyuncs.com/arms-docker-repo/arms-springboot-demo:v0.1
                  imagePullPolicy: Always
                  name: arms-springboot-demo-subcomponent
                  env:
                    - name: SELF_INVOKE_SWITCH
                      value: "false"
                    - name: MYSQL_SERVICE_HOST
                      value: "arms-demo-mysql"
                    - name: MYSQL_SERVICE_PORT
                      value: "3306"
        ---
        apiVersion: v1
        kind: Service
        metadata:
          labels:
            name: arms-demo-component
          name: arms-demo-component
          namespace: arms-demo
        spec:
          ports:
            # the port that this service should serve on
            - name: arms-demo-component-svc
              port: 6666
              targetPort: 8888
          # label keys and values that must match in order to receive traffic for this service
          selector:
            app: arms-springboot-demo-subcomponent
        ---
        apiVersion: apps/v1beta1 # for versions before 1.8.0 use apps/v1beta1
        kind: Deployment
        metadata:
          name: arms-demo-mysql
          namespace: arms-demo
          labels:
            app: mysql
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: mysql
          template:
            metadata:
              labels:
                app: mysql
            spec:
              containers:
                - resources:
                    limits:
                      cpu: 0.5
                  image: registry.cn-hangzhou.aliyuncs.com/arms-docker-repo/arms-demo-mysql:v0.1
                  name: mysql
                  ports:
                    - containerPort: 3306
                      name: mysql
        ---
        apiVersion: v1
        kind: Service
        metadata:
          labels:
            name: mysql
          name: arms-demo-mysql
          namespace: arms-demo
        spec:
          ports:
            # the port that this service should serve on
            - name: arms-mysql-svc
              port: 3306
              targetPort: 3306
          # label keys and values that must match in order to receive traffic for this service
          selector:
            app: mysql
        ---
        ```

    3.  执行如下命令，开启 ARMS 应用监控。

        ``` {#codeblock_edj_7uw_8pm}
        kubectl apply -f arms_demo.yaml
        ```

    单击**应用** \> **无状态**，查看相应的应用列表，在本例中使用的是无状态应用，您可以单击**前往ARMS控制台**查看应用的监控状态。

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/961258/156351911051661_zh-CN.png)


